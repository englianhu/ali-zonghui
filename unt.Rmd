---
title: "阿里彩票"
subtitle: "彩种报告 (Part II)"
author: "雷欧 <img src='figure/foxi_daoshi.jpg' width='24'>"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
---

# 简介

```{r results = 'asis', warning = FALSE, message = FALSE}
## 3210448065@qq.com
## leiou123

## 2849108450@qq.com
## leiou123
## https://rstudio.cloud/project/1198888

if(!require('BBmisc')) {install.packages('BBmisc')}
require('BBmisc')
pkg <- c('plyr', 'tidyverse', 'magrittr', 'readr', 'readxl', 'tidyr', 'MASS', 
         'knitr', 'kableExtra', 'forecast', 'formattable', 'DT', 'echarts4r', 
         'lubridate', 'highcharter', 'htmltools', 'readr', 'pryr', 'sparklyr', 
         'microbenchmark')

#plyr::l_ply(pkg, require, quietly = TRUE, character.only = TRUE, .print = FALSE)
suppressAll(lib(pkg))
rm(pkg)
#sc <- spark_connect(master = 'local')
```

当初在推广部门，**宋组长**给个样本数据，我就尝试使用线性模型和时间序列`arima`模型分析了进粉业绩，详情请参考[阿里彩票 - 分析样本数据](https://rpubs.com/englianhu/ali)。然后转到运维部门分析了[阿里彩票 - 彩种报告](https://rpubs.com/englianhu/ali_bet_type)，只是基本分析彩种，将数据视觉化；此商业分析进一步使用相互线性模型分析数据，预测彩种盈利。

- [如何 Estimate linear models](https://d.cosx.org/d/419820-estimate-linear-models)
- [`lm()`包中formula 表达方法的问题](https://d.cosx.org/d/157623-157623)

# 数据

读取样本数据。

```{r results = 'asis', warning = FALSE}
## 读取数据
fls <- suppressWarnings(list.files('data/彩种'))
smp <- fls %>% llply(., function(x) {
    dtt <- x %>% str_replace_all('.xls', '') %>% ymd
    smpp <- read_excel(paste0('data/彩种/', x)) %>% 
      .[-nrow(.),]
    data.frame('日期' = dtt, smpp)
}) %>% bind_rows %>% 
    as_tibble %>% 
    mutate(`彩种名称` = factor(彩种名称), `盈率` = as.numeric(percent(盈率))) %>% 
    mutate_if(is.character, as.numeric)
rm(fls)

nm <- names(smp)
names(smp) <- c('Date', 'Type', 'Bettor', 'Turnover', 'Won', 'Cancelled', 'Rebates', 'Profit', 'Profit_rate')

## 转化为大数据
smp2 <- smp
#smp2 <- copy_to(sc, smp2)

# smp %>% datatable(
#     caption = "彩种数据", 
#     escape = FALSE, filter = 'top', rownames = FALSE, 
#     extensions = list('ColReorder' = NULL, 'RowReorder' = NULL, 
#                       'Buttons' = NULL, 'Responsive' = NULL), 
#     options = list(dom = 'BRrltpi', autoWidth = TRUE,  scrollX = TRUE, 
#                    lengthMenu = list(c(10, 50, 100, 500, -1), 
#                                      c('10', '50', '100', '500', 'All')), 
#                    ColReorder = TRUE, rowReorder = TRUE, 
#                    buttons = list('copy', 'print', 
#                                   list(extend = 'collection', 
#                                        buttons = c('csv', 'excel', 'pdf'), 
#                                        text = 'Download'), I('colvis'))))

smp2 %>% 
  as_tibble %>% 
  kbl('html', caption = '每日投注人数', escape = F) %>% 
  kable_styling(
    bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  scroll_box(height = '400px')
```
