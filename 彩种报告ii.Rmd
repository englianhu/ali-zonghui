---
title: "阿里彩票"
subtitle: "彩种报告 (Part II)"
author: "雷欧 <img src='figure/foxi_daoshi.jpg' width='24'>"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
---

# 简介

```{r, results = 'asis', warning = FALSE, message = FALSE}
## 3210448065@qq.com
## leiou123

## 2849108450@qq.com
## leiou123
## https://rstudio.cloud/project/1198888
if(!require('BBmisc')) {install.packages('BBmisc')}
require('BBmisc')
pkg <- c('plyr', 'tidyverse', 'magrittr', 'readr', 'readxl', 'tidyr', 'MASS', 
         'knitr', 'kableExtra', 'forecast', 'formattable', 'DT', 'echarts4r', 
         'lubridate', 'highcharter', 'htmltools', 'readr', 'pryr', 'sparklyr', 
         'microbenchmark')

#plyr::l_ply(pkg, require, quietly = TRUE, character.only = TRUE, .print = FALSE)
suppressAll(lib(pkg))
rm(pkg)
#sc <- spark_connect(master = 'local')
```

当初在推广部门，**宋组长**给个样本数据，我就尝试使用线性模型和时间序列`arima`模型分析了进粉业绩，详情请参考[阿里彩票 - 分析样本数据](https://rpubs.com/englianhu/ali)。然后转到运维部门分析了[阿里彩票 - 彩种报告](https://rpubs.com/englianhu/ali_bet_type)，只是基本分析彩种，将数据视觉化；此商业分析进一步使用相互线性模型分析数据，预测彩种盈利。

- [如何 Estimate linear models](https://d.cosx.org/d/419820-estimate-linear-models)
- [`lm()`包中formula 表达方法的问题](https://d.cosx.org/d/157623-157623)

# 数据

读取样本数据。

```{r, results = 'asis', warning = FALSE}
## 读取数据
fls <- suppressWarnings(list.files('data/彩种'))
smp <- fls %>% llply(., function(x) {
    dtt <- x %>% str_replace_all('.xls', '') %>% ymd
    smpp <- read_excel(paste0('data/彩种/', x)) %>% 
      .[-nrow(.),]
    data.frame('日期' = dtt, smpp)
}) %>% bind_rows %>% 
    as_tibble %>% 
    mutate('彩种名称' = factor(彩种名称), '盈率' = as.numeric(percent(盈率))) %>% 
    mutate_if(is.character, as.numeric)
rm(fls)

nm <- names(smp)
names(smp) <- c('Date', 'Type', 'Bettor', 'Turnover', 'Won', 'Cancelled', 'Rebates', 'Profit', 'Profit_rate')

## 转化为大数据
smp2 <- smp
#smp2 <- copy_to(sc, smp2)

# smp %>% datatable(
#     caption = "彩种数据", 
#     escape = FALSE, filter = 'top', rownames = FALSE, 
#     extensions = list('ColReorder' = NULL, 'RowReorder' = NULL, 
#                       'Buttons' = NULL, 'Responsive' = NULL), 
#     options = list(dom = 'BRrltpi', autoWidth = TRUE,  scrollX = TRUE, 
#                    lengthMenu = list(c(10, 50, 100, 500, -1), 
#                                      c('10', '50', '100', '500', 'All')), 
#                    ColReorder = TRUE, rowReorder = TRUE, 
#                    buttons = list('copy', 'print', 
#                                   list(extend = 'collection', 
#                                        buttons = c('csv', 'excel', 'pdf'), 
#                                        text = 'Download'), I('colvis'))))

# smp2 %>% 
#   as_tibble %>% 
#   kbl('html', caption = '每日投注人数', escape = F) %>% 
#   kable_styling(
#     bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
#   scroll_box(height = '400px')
```

上图显示从`r smp$Date %>% range %>% .[1]`到`r smp$Date %>% range %>% .[2]`的报表数据，一共有`r nrow(smp2)`个观测值。

<br>
<br>

# 统计模型

<br>

## 基本模型

以下数据显示每日投注人数。

```{r, results = 'asis', warning = FALSE}
# smp2 %>%
#     spark_apply(
#         function(e) summary(lm(Profit ~ Turnover * Bettor * Won, e))$r.squared,
#         names = 'r.squared',
#         group_by = 'Type')

# 每日观测值
smp2 %>% 
    ddply(.(Date), nrow) %>% 
    as_tibble %>% dplyr::rename(n = V1) %>% 
  ## https://www.colorhexa.com/color-names
  mutate(n = color_tile('#007fff', 'white')(n)) %>% #azure
  kbl('html', caption = '每日投注人数', escape = F, align = 'c') %>% 
  kable_styling(
    bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  scroll_box(height = '400px')
```

我不晓得最优模型，先以全部数据为标准。

```{r, results = 'asis', eval = FALSE, warning = FALSE}
# lm1 <- lm(Profit ~ Type * Bettor * Turnover * Won * Cancelled * Rebates, smp2)

# m.aic.backward1 <- step(lm1, direction = 'backward', trace = 1)
# m.aic.backward2 <- step(lm1)

md <- list(
  m00 = lm(Profit ~ Date * Type * Bettor * Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m01 = lm(Profit ~ Type * Bettor * Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m02 = lm(Profit ~ Type * Bettor * Turnover * Won * Cancelled, smp2) %>% extractAIC, 
  m03 = lm(Profit ~ Type * Bettor * Turnover * Won * Rebates, smp2) %>% extractAIC, 
  m04 = lm(Profit ~ Type * Bettor * Turnover * Cancelled * Rebates, smp2) %>% extractAIC, 
  m05 = lm(Profit ~ Type * Bettor * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m06 = lm(Profit ~ Type * Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m07 = lm(Profit ~ Bettor * Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m08 = lm(Profit ~ Type * Bettor * Turnover * Won, smp2) %>% extractAIC, 
  m09 = lm(Profit ~ Type * Bettor * Turnover * Rebates, smp2) %>% extractAIC, 
  m10 = lm(Profit ~ Type * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m11 = lm(Profit ~ Type * Bettor * Turnover * Cancelled, smp2) %>% extractAIC, 
  m12 = lm(Profit ~ Type * Bettor * Won * Rebates, smp2) %>% extractAIC, 
  m13 = lm(Profit ~ Type * Bettor * Won * Cancelled, smp2) %>% extractAIC, 
  m14 = lm(Profit ~ Type * Turnover * Won * Rebates, smp2) %>% extractAIC, 
  m15 = lm(Profit ~ Type * Turnover * Cancelled * Rebates, smp2) %>% extractAIC, 
  m16 = lm(Profit ~ Type * Turnover * Won * Rebates, smp2) %>% extractAIC, 
  m17 = lm(Profit ~ Type * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m18 = lm(Profit ~ Bettor * Turnover * Won * Cancelled, smp2) %>% extractAIC, 
  m19 = lm(Profit ~ Bettor * Turnover * Won * Rebates, smp2) %>% extractAIC, 
  m20 = lm(Profit ~ Bettor * Turnover * Cancelled * Rebates, smp2) %>% extractAIC, 
  m21 = lm(Profit ~ Type * Bettor * Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC, 
  m22 = lm(Profit ~ Turnover * Won * Cancelled * Rebates, smp2) %>% extractAIC) %>% 
  ldply %>% 
  as_tibble %>% 
  dplyr::rename(df = V1, AIC = V2) %>% 

## save files, easier to read.
microbenchmark(
   save(md, file = 'data/md.rda'), 
   write_rds(md, path = 'data/md.rds'), 
   saveRDS(md, file = 'data/md.rds'))
#Unit: microseconds
#                                expr     min       lq     mean   median      uq     max neval
#      save(md, file = "data/md.rda") 114.666 130.9080 135.2061 134.3990 137.111 174.759   100
# write_rds(md, path = "data/md.rds") 111.098 120.6370 126.8601 125.1935 129.534 178.582   100
#   saveRDS(md, file = "data/md.rds") 143.649 160.3135 178.6935 183.2730 186.673 358.803   100
```

以上使用`lm()`函数，模型从`m00`~`m22`。

```{r, results = 'asis', warning = FALSE}
md <- read_rds(path = 'data/md.rds')
md2 <- md

## https://www.colorhexa.com/color-names
md2 %>% 
  formattable(
    list(
        AIC = formatter('span', style = x ~ formattable::style(
            color = ifelse(rank(x) <= 3, 'darkgoldenrod', 'grey')), 
            x ~ paste0(round(x, 2), 
                       ' (rank: ', sprintf('%1.f', rank(x)), ')')))) %>% 
    mutate(df = color_tile('#2a52be', 'white')(df))#colbalt
md2
```

```{r, results = 'asis', warning = FALSE}
## https://www.colorhexa.com/color-names
md2 %>% 
  mutate(
    df = color_tile('#2a52be', 'white')(df), #colbalt
    AIC = ifelse(
      rank(AIC) <= 3, 
      cell_spec(
        paste0(round(AIC, 2), ' (rank: ', sprintf('%1.f', rank(AIC)), ')'), 
        'html', color = 'darkgoldenrod', bold = T), 
      cell_spec(
        paste0(round(AIC, 2), ' (rank: ', sprintf('%1.f', rank(AIC)), ')'), 
        'html', color = 'grey', italic = T))) %>% 
  kbl('html', caption = '最优模型', escape = F, align = c('c', 'r', 'r')) %>% 
  kable_styling(
    bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material() %>% 
  scroll_box(height = '400px')
```

<br>
<br>

# 绘图

<br>

## 投注人数

<br>

## 投注金额

<br>

## 中奖金额

<br>

## 撤单金额

<br>

## 返点金额

<br>

## 盈利

<br>

## 盈率

<br>
<br>

# 结论

<br>

## 总结

以上是将数据绘图，还需要通过统计模型预测，不过基于数据观测值太少^[[binary.com Interview Question I (Extention)](https://rpubs.com/englianhu/binary-Q1E)尝试分别使用`3个月`、`6个月`、`12个月`、`18个月`和`24个月`的数据，结果`12个月`的数据最为精准。]，所以暂时没有预测。

<br>

## 附录

```{r, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('magrittr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))
suppressMessages(require('knitr', quietly = TRUE))
suppressMessages(require('kableExtra', quietly = TRUE))

sys1 <- devtools::session_info()$platform %>% 
  unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL

sys2 <- data.frame(Sys.info()) %>% mutate(Category = rownames(.)) %>% .[2:1]
names(sys2)[2] <- c('Sys.info')
rownames(sys2) <- NULL

if (nrow(sys1) == 9 & nrow(sys2) == 8) {
  sys2 %<>% rbind(., data.frame(
  Category = 'Current time', 
  Sys.info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JST')))
} else {
  sys1 %<>% rbind(., data.frame(
  Category = 'Current time', 
  session_info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JST')))
}

cbind(sys1, sys2) %>% 
  kable(caption = 'Additional session information:') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive'))

rm(sys1, sys2)
```

## 参考文献

1) [Free themes for Bootstrap](https://bootswatch.com/3/)

2) [R packages for optimal stratified sampling: a review and compared evaluation](https://www.researchgate.net/publication/327791484_R_packages_for_optimal_stratified_sampling_a_review_and_compared_evaluation/comments)

3) [Use of models in SamplingStrata](https://cran.r-project.org/web/packages/SamplingStrata/vignettes/models.html)

